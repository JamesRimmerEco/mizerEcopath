<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Incorporating predation diffusion • mizerEcopath</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.1/jquery-3.6.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="diffusion_files/libs/quarto-html/popper.min.js"></script><script src="diffusion_files/libs/quarto-html/tippy.umd.min.js"></script><link href="diffusion_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="diffusion_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Incorporating predation diffusion">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mizerEcopath</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9004</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/mizerEcopath.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/diffusion.html">Incorporating predation diffusion</a></li>
    <li><a class="dropdown-item" href="../articles/ecopath_to_mizer.html">From Ecopath to Mizer</a></li>
    <li><a class="dropdown-item" href="../articles/todo.html">Todo list</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/gustavdelius/mizerEcopath/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Incorporating predation diffusion</h1>




      <small class="dont-index">Source: <a href="https://github.com/gustavdelius/mizerEcopath/blob/HEAD/vignettes/diffusion.qmd" class="external-link"><code>vignettes/diffusion.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gustavdelius/mizerEcopath" class="external-link">mizerEcopath</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: mizer</span></span>
<span><span class="co">#&gt; Loading required package: mizerExperimental</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'mizerEcopath'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:mizerExperimental':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     alignResource</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="va">NS_params</span></span></code></pre></div>
</div>
<section class="section level2"><h2 id="sec-jump-growth">The jump-growth equation<a class="anchor" aria-label="anchor" href="#sec-jump-growth"></a>
</h2>
<p>As was observed in <span class="citation" data-cites="datta2010">(<a href="#ref-datta2010" role="doc-biblioref">Datta, Delius, and Law 2010</a>)</span>, the variability in prey size leads to a diffusion term in the PDE for the abundance density <span class="math inline">\(N(w,t)\)</span>. This term is neglected in mizer but may well become important when modelling seasonality because it will contribute to a broadening of the yearly cohorts as they grow up. The PDE including the diffusion term is <span id="eq-PDE"><span class="math display">\[
\frac{\partial N}{\partial t} = \frac12 \frac{\partial^2}{\partial w^2}(d N) - \frac{\partial}{\partial w}(g N)-\mu N
\tag{1}\]</span></span> where <span class="math inline">\(g\)</span> is the growth rate, <span class="math inline">\(\mu\)</span> is the death rate and <span class="math inline">\(d\)</span> is a new diffusion rate.</p>
<p>The diffusion rate has an expression that is similar to that of the growth rate. Recall that the growth rate is given by <span id="eq-gw"><span class="math display">\[
\begin{split}
g(w)=&amp;(1-f(w))\,\gamma(w)\int N_c(w_p)\phi(w/w_p)\alpha\,(1-\psi(w)) w_p\,dw_p\\
&amp;- K(w)(1-\psi(w)),
\end{split}
\tag{2}\]</span></span> where <span class="math inline">\(N_c(w)\)</span> is the abundance density of prey, <span class="math inline">\(\phi(w/w_p)\)</span> is the predation kernel, <span class="math inline">\(\gamma(w)\)</span> is the search volume, <span class="math inline">\(f(w)\)</span> is the feeding level, <span class="math inline">\(K(w)\)</span> is the metabolic respiration rate, <span class="math inline">\(\alpha\)</span> is the conversion efficiency and <span class="math inline">\(\psi(w)\)</span> is the proportion of available energy that is invested into reproduction. Because the metabolic respiration loss is subtracted from the available energy before that is split into growth and reproduction, only a proportion <span class="math inline">\(1-\psi\)</span> of the metabolic rate is subtracted from the growth rate.</p>
<p>The factor <span class="math inline">\(\alpha (1- \psi(w))w_p\)</span> in the integral in <a href="#eq-gw" class="quarto-xref">Eq. 2</a> is the increase in somatic weight of the predator resulting from the ingestion of the prey of weight <span class="math inline">\(w_p\)</span>. In the expression for the diffusion rate <span class="math inline">\(d(w)\)</span> this factor is squared: <span class="math display">\[
d(w) = (1-f(w))\,\gamma(w) \int N_c(w_p)\phi(w/w_p)(\alpha\,(1-\psi(w)) w_p)^2\,dw_p.
\]</span> The loss due to metabolic respiration affects the growth rate but not the diffusion rate. In the derivation of the PDE <a href="#eq-PDE" class="quarto-xref">Eq. 1</a> in <span class="citation" data-cites="datta2010">(<a href="#ref-datta2010" role="doc-biblioref">Datta, Delius, and Law 2010</a>)</span> the metabolic respiration was not discussed but its contribution to only the first-order derivative term can be found in <span class="citation" data-cites="capitan2010">(<a href="#ref-capitan2010" role="doc-biblioref">Capitan and Delius 2010</a>)</span>.</p>
<p>The increase <span class="math inline">\(\alpha (1- \psi(w))w_p\)</span> in predator mass is typically only a small proportion of the predator mass because the preferred prey are typically much smaller than the predator and also <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(1-\psi(w)\)</span> are both smaller than <span class="math inline">\(1\)</span>. Because this factor is squared in the expression for <span class="math inline">\(d(w)\)</span> it might be expected that the term in the PDE involving <span class="math inline">\(d(w)\)</span> can be safely neglected. However it is worth testing this intuition. We will do this now by first determining the diffusion rate in a model with allometric growth and death rates. We will then use that to determine its effect on the slope of the juvenile spectrum.</p>
</section><section class="section level2"><h2 id="sec-diffusion-example">Example calculation of diffusion rate<a class="anchor" aria-label="anchor" href="#sec-diffusion-example"></a>
</h2>
<p>Let us assume that the prey abundance is given by a power law: <span class="math inline">\(N_c(w)=N_0w^{-\lambda}\)</span> and that the predation kernel is <span class="math display">\[
\phi(w/w_p) = \exp\left(-\frac{\log(w/w_p/\beta)^2}{2\sigma^2}\right).
\]</span></p>
<p>For juveniles <span class="math inline">\(\psi(w)=0\)</span> and hence the integral in the expression <a href="#eq-gw" class="quarto-xref">Eq. 2</a> for the growth rate becomes <span class="math display">\[
I_g:=\int N_c(w_p)\phi(w/w_p)\alpha\,(1-\psi(w)) w_p\,dw_p =
\alpha\int w_p^{1-\lambda}\exp\left(-\frac{\log(w/w_p/\beta)^2}{2\sigma^2}\right)dw_p.
\]</span> This integral can be evaluated most easily by changing integration variable to <span class="math inline">\(x=\log(w_p/w_0)\)</span>for an arbitrary reference weight <span class="math inline">\(w_0\)</span> and then recognising the resulting integral <span class="math display">\[
I_g=\alpha\, w_0^{2-\lambda}\int e^{(2-\lambda)x}\exp\left(-\frac{(x-\log(w/w_0)+\log(\beta))^2}{2\sigma^2}\right)dx
\]</span> as a Gaussian integral. Using the general result that <span class="math display">\[
\int e^{ax}\exp\left(-\frac{(x-\mu)^2}{2\sigma^2}\right)dx = \sqrt{\frac{2\pi}{\sigma^2}}\exp\left(a\mu+\frac{a^2\sigma^2}{2}\right)
\]</span> with <span class="math inline">\(a = 2-\lambda\)</span> and <span class="math inline">\(\mu = \log(w)-\log(\beta)\)</span> we find that <span class="math display">\[
\begin{split}
I_g&amp;=
\alpha\, w_0^{2-\lambda}\sqrt{\frac{2\pi}{\sigma^2}}\exp\left((2-\lambda)(\log(w/w_0)-\log(\beta))+\frac{(2-\lambda)^2\sigma^2}{2}\right)\\
&amp;=\alpha w^{2-\lambda}\sqrt{\frac{2\pi}{\sigma^2}}\beta^{\lambda - 2}\exp\left(\frac{(2-\lambda)^2\sigma^2}{2}\right)
\end{split}
\]</span></p>
<p>Assuming further a constant feeding level <span class="math inline">\(f(w)=f\)</span>, an allometric metabolic loss rate <span class="math inline">\(K(w) = k_s w^n\)</span> and an allometric search volume <span class="math inline">\(\gamma(w)=\gamma w^q\)</span> with an exponent of <span class="math inline">\(q = n + 2 - \lambda\)</span> we obtain <span class="math display">\[
g(w) = \left((1-f)\gamma \alpha \sqrt{\frac{2\pi}{\sigma^2}}\beta^{\lambda - 2}\exp\left(\frac{(2-\lambda)^2\sigma^2}{2}\right)-k_s\right) w^n.
\]</span> If we assume further that the metabolic loss is a fraction <span class="math inline">\(f_c/f\)</span> of the incoming energy (we refer to <span class="math inline">\(f_c\)</span> as the critical feeding level) then this simplifies to <span id="eq-gwe"><span class="math display">\[
g(w) =\left( \left(1-\frac{f_c}{f}\right)(1-f)\gamma \alpha \sqrt{\frac{2\pi}{\sigma^2}}\beta^{\lambda - 2}\exp\left(\frac{(2-\lambda)^2\sigma^2}{2}\right)\right) w^n.
\tag{3}\]</span></span></p>
<p>We can evaluate the diffusion rate <span class="math inline">\(d(w)\)</span> in the same manner. The extra factor of <span class="math inline">\(w_p\)</span> changes <span class="math inline">\(a\)</span> from <span class="math inline">\(2-\lambda\)</span> to <span class="math inline">\(3-\lambda\)</span> and we obtain <span class="math display">\[
d(w) = \left((1-f(w))\gamma \alpha^2 \sqrt{\frac{2\pi}{\sigma^2}}\beta^{\lambda - 3}\exp\left(\frac{(3-\lambda)^2\sigma^2}{2}\right)\right) w^n.
\]</span> Comparing this to the expression <a href="#eq-gwe" class="quarto-xref">Eq. 3</a> for <span class="math inline">\(g(w)\)</span> we find that <span class="math display">\[
d(w) = g(w)w\frac{1}{1-f_c/f}\frac{\alpha}{\beta}\exp\left(\frac{(2\lambda - 3)\sigma^2}{2}\right).
\]</span></p>
<p>To get a feel for the typical magnitude of the factor let’s consider concrete values <span class="math inline">\((1-f_c/f)=0.6\)</span>, <span class="math inline">\(\alpha = 0.8\)</span>, <span class="math inline">\(\beta = 100\)</span>, <span class="math inline">\(\sigma = 1\)</span> and <span class="math inline">\(\lambda = 2\)</span>. Then <span class="math inline">\(d(w) \approx 0.02 g(w)w\)</span>. However we see that the value of <span class="math inline">\(d(w)\)</span> is strongly influenced by the width of the feeding kernel. If we choose <span class="math inline">\(\sigma = 2\)</span> then <span class="math inline">\(d(w)\approx0.1g(w)w\)</span>. This increase in the diffusion rate with increasin <span class="math inline">\(\sigma\)</span> may explains the result from <span class="citation" data-cites="datta2010a">(<a href="#ref-datta2010a" role="doc-biblioref">Datta et al. 2010</a>)</span> that the stability of the system increases with increasing <span class="math inline">\(\sigma\)</span>.</p>
</section><section class="section level2"><h2 id="sec-diffusion-juvenile">Effect on juvenile slope<a class="anchor" aria-label="anchor" href="#sec-diffusion-juvenile"></a>
</h2>
<p>Now we are ready to investigate the effect of the diffusion on the slope of the juvenile spectrum in the steady state. Without diffusion we find the juvenile spectrum by solving the steady-state equation <span class="math display">\[
\frac{\partial}{\partial w}(g(w) N(w)) =-\mu(w) N(w).
\]</span> This has the solution <span class="math display">\[
N(w) = \frac{g(w_0)}{g(w)}N(w_0)\exp\left(-\int_{w_0}^w\frac{\mu(w')}{g(w')}dw'\right).
\]</span> With allometic growth and death rates <span class="math inline">\(g(w)=g_0w^n\)</span> and <span class="math inline">\(\mu(w)=\mu_0w^{n-1}\)</span> this gives <span class="math display">\[
N(w)=\left(\frac{w}{w_0}\right)^{-n} N(w_0)\exp\left(-\frac{\mu_0}{g_0}\int_{w_0}^w\frac{1}{w'}dw'\right)=N(w_0)\left(\frac{w}{w_0}\right)^{-\mu_0/g_0-n}
\]</span> Thus the juvenile steady state abundance density is given by a power law with exponent <span class="math inline">\(-\mu_0/g_0-n\)</span>.</p>
<p>In the presence of diffusion the steady state equation becomes the second-order ODE <span id="eq-diffss"><span class="math display">\[
\frac12 \frac{\partial^2}{\partial w^2}(d N) - \frac{\partial}{\partial w}(g N)-\mu N=0.
\tag{4}\]</span></span></p>
<p>We have seen in the previous section that with <span class="math inline">\(g(w)=g_0w^n\)</span> the diffusion rate is also a power law with one extra factor of <span class="math inline">\(w\)</span>: <span class="math inline">\(d(w)=d_0w^{n+1}\)</span>. This makes the equation <a href="#eq-diffss" class="quarto-xref">Eq. 4</a> scale invariant and hence we again expect the solution to be a power law, So we make the Ansatz <span class="math inline">\(N(w)=N(w_0)(w/w_0)^a\)</span> with the exponent <span class="math inline">\(a\)</span> to be determined. Substituting this Ansatz into <a href="#eq-diffss" class="quarto-xref">Eq. 4</a> gives <span class="math display">\[
\frac12 d_0N_0(n+1+a)(n+a)w^{n+a-1} -g_0N_0(n+a)w^{n+a-1}-\mu_0 N_0w^{n-1+a} = 0
\]</span> which requires that <span class="math display">\[
\frac12 d_0(n+1+a)(n+a) -g_0(n+a)-\mu_0= 0.
\]</span> This is a quadratic equation for <span class="math inline">\(n+a\)</span>: <span class="math display">\[
\frac12 d_0 (n+a)^2+\left(\frac12 d_0 -g_0\right)(n+a)-\mu_0=0.
\]</span> This has two solutions <span class="math display">\[
(n+a_\pm) = \frac1{d_0}\left(g_0-d_0/2\pm\sqrt{(g_0-d_0/2)^2+2d_0\mu_0}\right)
\]</span></p>
<p>We are only interested in the solution that goes to <span class="math inline">\(a=-\mu_0/g_0-n\)</span> when <span class="math inline">\(d_0\to 0\)</span>. This means we are interested in the solution with the - sign. To check that indeed the solution <span class="math inline">\(a_{-}\)</span> satisfies <span class="math inline">\(\lim_{a_-\to 0}= -\mu_0/g_0-n\)</span> it is helpful to expand the square root term around <span class="math inline">\(d_0=0\)</span>: <span class="math display">\[
\sqrt{(g_0-d_0/2)^2+2d_0\mu_0}=g_0+\frac{-g_0+2\mu_0}{2g_0}d_0+\frac{g_0^2-(-g_0+2\mu_0)^2}{8g_0^3}d_0^2+\dots
\]</span> So we find <span class="math display">\[
\begin{split}
a &amp;= -n+\frac1{d_0}\left(g_0-d_0/2-\sqrt{(g_0-d_0/2)^2+2d_0\mu_0}\right)\\
&amp;\approx -n-\frac{\mu_0}{g_0} - \frac18\left(1-\left(-1+2\frac{\mu_0}{g_0}\right)^2\right) d_0+\dots\\
&amp;=-n-\frac{\mu_0}{g_0} +\frac12\left(\frac{\mu_0}{g_0}\left(1-\frac{\mu_0}{g_0}\right)\right)\frac{d_0}{g_0}+\dots
\end{split}
\]</span></p>
<p>We see that when <span class="math inline">\(\mu_0=g_0\)</span> then the first correction term to the juvenile slope vanishes. The largest increase in slope (i.e., the least negative slope) is achieved when <span class="math inline">\(\mu_0/g_0=1/2\)</span>. In that case the slope without diffusion is <span class="math inline">\(-1.25\)</span> (assuming $n=0.75). The correction term then is <span class="math inline">\(1/8 d_0/g_0\)</span>. We had already seen in the previous section that <span class="math inline">\(d_0/g_0\)</span> is typically very small, so the change in slope is also very small.</p>
<p>Using the example value of <span class="math inline">\(d_0/g_0=0.002\)</span> and <span class="math inline">\(n=0.75\)</span> we get a slope correction of <span class="math inline">\(0.00025\)</span> from <span class="math inline">\(-1.25\)</span> to <span class="math inline">\(-1.24975\)</span>. Using the value <span class="math inline">\(d_0/g_0=0.1\)</span> we get a larger slope correction of <span class="math inline">\(0.0125\)</span> from <span class="math inline">\(-1.25\)</span> to <span class="math inline">\(-1.2375\)</span>. While this still seems irrelevant, we have to remember that we are looking at a power law exponent and that small changes in the exponent can have a large effect on the value of the power law. If, for example, we have a fixed abundance of eggs of size 0.001g and then look at the resulting density of fish of 1000g, then the diffusion correction increases that by a factor of <span class="math inline">\((10^6)^{0.0125}\approx 1.19\)</span>, an increase by 19\%.</p>
<p>When <span class="math inline">\(\mu_0/g_0&gt;1\)</span> then the diffusion correction is negative, i.e., the juvenile slope becomes more negative due to diffusion, meaning fewer large fish.</p>
</section><section class="section level2"><h2 id="sec-diffusion-log">Transforming to logarithmic weight<a class="anchor" aria-label="anchor" href="#sec-diffusion-log"></a>
</h2>
<p>Mizer works with logarithmically-spaced weight bins. That is good, but it makes it complicated to work out numerical schemes for solving the equations. It is much easier to work with equally-spaced bins. The obvious solution is to view the logarithm of the weight as the independent variable instead of the weight. So we will work with <span class="math display">\[
x = \log(w/w_0)
\]</span> where <span class="math inline">\(w_0\)</span> is an arbitrary reference weight. That transforms the logarithmically-spaced bins in <span class="math inline">\(w\)</span> to equally-spaced bins in <span class="math inline">\(x\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sizespectrum.org/mizer/reference/w.html" class="external-link">w</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">w</span> <span class="op">/</span> <span class="va">w</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">h</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
</div>
<p>We should then also work with the abundance density as a function of <span class="math inline">\(x\)</span>. Let’s denote it by <span class="math inline">\(n(x)\)</span>. It is related to the abundance density <span class="math inline">\(N(w)\)</span> by <span class="math display">\[
n(x)dx = N(w)dw
\]</span> Because <span class="math inline">\(dx = dw / w\)</span> this means <span class="math inline">\(N(w)=n(w)/w\)</span>.</p>
<p>By the chain rule we have <span class="math display">\[
\frac{\partial}{\partial w} = \frac{\partial x}{\partial w}\frac{\partial}{\partial x} = \frac{1}{w}\frac{\partial}{\partial x}
\]</span></p>
<p>We can now transform the PDE <a href="#eq-PDE" class="quarto-xref">Eq. 1</a> for <span class="math inline">\(N(w,t)\)</span> into a PDE for <span class="math inline">\(n(x,t)\)</span>: <span id="eq-PDEx"><span class="math display">\[
\frac{\partial n}{\partial t} = \frac12 \frac{\partial}{\partial x}\left(\frac{1}{w}\frac{\partial}{\partial x}\frac{d n}{w}\right) - \frac{\partial}{\partial x}\left(\frac{g n}{w}\right)-\mu n
\tag{5}\]</span></span> We rewrite this using that <span class="math display">\[
\frac{1}{w}\frac{\partial}{\partial x}\frac{d n}{w} = \frac{\partial}{\partial x}\frac{d n}{w^2}+\frac{d n}{w^2}
\]</span> Introducing the rescaled growth and diffusion rates <span class="math display">\[
\tilde{g} = \frac{g}{w}-\frac12\frac{d}{w^2},~~~~\tilde{d}=\frac{d}{w^2}
\]</span> simplifies the PDE <a href="#eq-PDEx" class="quarto-xref">Eq. 5</a> to <span id="eq-PDExs"><span class="math display">\[
\frac{\partial n}{\partial t} = \frac12 \frac{\partial^2}{\partial x^2}(\tilde{d}n) - \frac{\partial}{\partial x}\left(\tilde{g}n\right)-\mu n
\tag{6}\]</span></span> Note that while the diffusion rate was just rescaled by the factor of <span class="math inline">\(1/w^2\)</span> that should be expected from the transformation from <span class="math inline">\(d^2/dw^2\)</span> to <span class="math inline">\(d^2/dx^2\)</span>, the growth rate also received an additional contribution from the diffusion.</p>
<p>We can also write the PDE in a form where the derivatives act directly on <span class="math inline">\(n\)</span> by expanding <span class="math display">\[
\frac{\partial}{\partial x}\left(\tilde{g}n\right) = \tilde{g}'n + \tilde{g}n'
\]</span> and <span class="math display">\[
\frac12 \frac{\partial^2}{\partial x^2}(\tilde{d}n)=\frac12\tilde{d}''n+\tilde{d}'n'+\frac12\tilde{d}n''
\]</span> where we have denoted the derivative with respect to <span class="math inline">\(x\)</span> by a prime. Collecting terms gives <span class="math display">\[
\frac{\partial n}{\partial t} = \frac12 \tilde{d}n'' - \left(\tilde{g}-\tilde{d'}\right)n'-\left(\mu +\tilde{g}'-\frac12\tilde{d}''\right)n
\]</span></p>
</section><section class="section level2"><h2 id="sec-diffusion-numerical">Numerical scheme for steady-state ODE<a class="anchor" aria-label="anchor" href="#sec-diffusion-numerical"></a>
</h2>
<p>We can now obtain the steady-state abundance density by solving the second-order ODE <span class="math display">\[
an''-bn'-cn=0
\]</span> with <span class="math display">\[
a = \frac12 \tilde{d},~~~~b=\tilde{g}-\tilde{d}',~~~~c=\mu +\tilde{g}'-\frac12\tilde{d}''.
\]</span> Our boundary conditions are <span class="math display">\[
n(x_0)=n_0,~~~~n(x_{max})=0.
\]</span> where <span class="math inline">\(x_{max}\)</span> is some size that fish can never reach.</p>
<p>We solve this with a second-order finite-difference scheme, using our equally-spaced grid with spacing <span class="math inline">\(h\)</span>: <span class="math inline">\(x_i = x_0 + ih\)</span> for <span class="math inline">\(i=0,\dots,N+1\)</span> such that <span class="math inline">\(x_{N+1}=x_{max}\)</span>. We use the notation <span class="math inline">\(n(x_i)=n_i\)</span>. The finite-difference approximations to the derivatives are <span class="math display">\[
n'(x_i)=\frac{n_{i+1}-n_{i-1}}{2h},~~~~n''(x_i)=\frac{n_{i+1}-2n_i+n_{i-1}}{h^2}.
\]</span> That gives us the linear system <span id="eq-UDL"><span class="math display">\[
U_i n_{i+1}+D_i n_i+L_i n_{i-1}=0
\tag{7}\]</span></span> with <span class="math display">\[
U_i=a_i-\frac{h}{2}b_i, \qquad L_i=a_i-\frac{h}{2}b_i \qquad \text{ and }~~~D_i = -2a_i-h^2c_i
\]</span> for <span class="math inline">\(i=1,\dots,N\)</span>. This can be solved by making the Ansatz <span id="eq-alphabeta"><span class="math display">\[
n_{i-1}=\alpha_in_i+\beta_i
\tag{8}\]</span></span> for <span class="math inline">\(i=1,\dots N\)</span>, where <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(\beta_i\)</span> are to be determined. Substituting <a href="#eq-alphabeta" class="quarto-xref">Eq. 8</a> this into <a href="#eq-UDL" class="quarto-xref">Eq. 7</a> gives <span id="eq-UDL2"><span class="math display">\[
U_in_{i+1}+(\alpha_iL_i+D_i)n_i+\beta_iL_i=0.
\tag{9}\]</span></span> Similarly using <span class="math inline">\(n_{i}=\alpha_{i+1}n_{i+1}+\beta_{i+1}\)</span> in <a href="#eq-UDL2" class="quarto-xref">Eq. 9</a> gives <span id="eq-UDL3"><span class="math display">\[
\left[U_i + (\alpha_iL_i+D_i)\alpha_{i+1}\right]n_{i+1}+\left[(\alpha_iL_i+D_i)\beta_{i+1}+\beta_iL_i\right]=0.
\tag{10}\]</span></span> We can satisfy this by making the expressions in the square brackets vanish, which gives us <span id="eq-alphabetarecursion"><span class="math display">\[
\alpha_{i+1}=-\frac{U_i}{\alpha_iL_i+D_i},\qquad \beta_{i+1}=-\frac{\beta_iL_i}{\alpha_iL_i+D_i}.
\tag{11}\]</span></span> Looking at <a href="#eq-alphabeta" class="quarto-xref">Eq. 8</a> for <span class="math inline">\(i=1\)</span>, i.e., <span class="math inline">\(n_0 = \alpha_1n_1+\beta_1\)</span> we see that we can choose <span class="math inline">\(\alpha_1=0\)</span> and <span class="math inline">\(\beta_1=n_0\)</span>. We can now use <a href="#eq-alphabetarecursion" class="quarto-xref">Eq. 11</a> to determine the all the <span class="math inline">\(\alpha\)</span>s and <span class="math inline">\(\beta\)</span>s. Starting from the boundary condition <span class="math inline">\(n_{N+1}=0\)</span> we can then use <a href="#eq-alphabeta" class="quarto-xref">Eq. 8</a> to determine the remaining <span class="math inline">\(n_i\)</span>.</p>
<p>This scheme is known to be stable if <span class="math inline">\(U_i,L_i&gt;0\)</span>, <span class="math inline">\(D_i&lt;0\)</span> and <span class="math inline">\(U_i+L_i\leq -D_i\)</span>. The requirement that <span class="math inline">\(U_i&gt;0\)</span> gives us a maximum step size of <span class="math display">\[
h\leq\frac{\tilde{d}}{\tilde{g}-\tilde{d}'}.
\]</span></p>
<p>We implement this in the function <code>solve_steady_state_ode</code> as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">solve_steady_state_ode</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span>, <span class="va">n0</span>, <span class="va">h</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Number of interior points</span></span>
<span>    <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    </span>
<span>    <span class="co"># Calculate finite difference scheme coefficients</span></span>
<span>    <span class="va">U</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">-</span> <span class="va">h</span><span class="op">/</span><span class="fl">2</span> <span class="op">*</span> <span class="va">b</span>     <span class="co"># Upper diagonal</span></span>
<span>    <span class="va">L</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">+</span> <span class="va">h</span><span class="op">/</span><span class="fl">2</span> <span class="op">*</span> <span class="va">b</span>     <span class="co"># Lower diagonal </span></span>
<span>    <span class="va">D</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="va">a</span> <span class="op">-</span> <span class="va">h</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">c</span>  <span class="co"># Main diagonal</span></span>
<span>    </span>
<span>    <span class="co"># Check stability conditions</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">U</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">L</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">D</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Stability conditions not met. Try reducing step size h."</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">U</span> <span class="op">+</span> <span class="va">L</span> <span class="op">&gt;</span> <span class="op">-</span><span class="va">D</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Stability condition U + L &lt;= -D not met."</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Solve using double sweep method</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu">solve_ode_double_sweep</span><span class="op">(</span><span class="va">U</span>, <span class="va">L</span>, <span class="va">D</span>, <span class="va">n0</span>, <span class="va">N</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Helper function for double sweep method</span></span>
<span><span class="va">solve_ode_double_sweep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">U</span>, <span class="va">L</span>, <span class="va">D</span>, <span class="va">n0</span>, <span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Initialize arrays for alpha and beta coefficients</span></span>
<span>    <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">N</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">N</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">N</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Initial conditions</span></span>
<span>    <span class="va">alpha</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">n0</span></span>
<span>    </span>
<span>    <span class="co"># Forward sweep - calculate alpha and beta coefficients</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">denom</span> <span class="op">&lt;-</span> <span class="va">alpha</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">L</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">D</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>        <span class="va">alpha</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">U</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span> <span class="va">denom</span></span>
<span>        <span class="va">beta</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">L</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">denom</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Backward sweep - calculate n values</span></span>
<span>    <span class="va">n</span><span class="op">[</span><span class="va">N</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>  <span class="co"># Boundary condition at x_max</span></span>
<span>    </span>
<span>    <span class="co"># Work backwards to get remaining n values</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">N</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">n</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">alpha</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">n</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">beta</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</section><section class="section level2"><h2 id="sec-diffusion-NS">North Sea Cod example<a class="anchor" aria-label="anchor" href="#sec-diffusion-NS"></a>
</h2>
<p>We will now implement this in an example. We start with the North Sea Cod.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">species</span> <span class="op">&lt;-</span> <span class="st">"Cod"</span></span>
<span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sizespectrum.org/mizer/reference/species_params.html" class="external-link">species_params</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span><span class="op">[</span><span class="va">species</span>, <span class="op">]</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="va">sps</span><span class="op">$</span><span class="va">n</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="va">sps</span><span class="op">$</span><span class="va">m</span></span>
<span><span class="va">w_mat</span> <span class="op">&lt;-</span> <span class="va">sps</span><span class="op">$</span><span class="va">w_mat</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">w_mat</span> <span class="op">/</span> <span class="va">sps</span><span class="op">$</span><span class="va">w_mat25</span><span class="op">)</span></span>
<span><span class="va">w_repro_max</span> <span class="op">&lt;-</span> <span class="va">sps</span><span class="op">$</span><span class="va">w_repro_max</span></span>
<span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sizespectrum.org/mizer/reference/getMort.html" class="external-link">getMort</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span><span class="op">[</span><span class="va">species</span>, <span class="op">]</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sizespectrum.org/mizer/reference/getEGrowth.html" class="external-link">getEGrowth</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span><span class="op">[</span><span class="va">species</span>, <span class="op">]</span></span>
<span><span class="co"># At small size we have $g(w) = g_0 w^n$, hence $g_0 = g(w)/w^n$</span></span>
<span><span class="va">g_0</span> <span class="op">&lt;-</span> <span class="va">g</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">w</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="va">n</span></span></code></pre></div>
</div>
<p>To calculate the derivative of the growth rate we go back to the expression for the growth rate and calculate the derivatives of the terms in the expression. For simplicity we set metabolic loss to zero. <span class="math display">\[
g(w)=g_0w^n(1-\psi(w))
\]</span> where <span class="math inline">\(\psi(w)\)</span> is the proportion of available energy that is invested into reproduction. <span class="math display">\[
\psi(w) = \left(1+\left(\frac{w}{w_{mat}}\right)^{U}\right)^{-1}\left(\frac{w}{w_{repro\_max}}\right)^{m-n}
\]</span> For the derivative we get after some simplification (see https://chatgpt.com/share/678776f5-bf00-8007-9549-f1d186829235), <span class="math display">\[
\frac{d}{dw}g(w) = g_0 w^{n-1} \left( n - \frac{\left(m + (m - U)\left(\frac{w}{w_{\text{mat}}}\right)^U\right) \left(\frac{w}{w_{\text{repro\_max}}}\right)^{m-n}}{\left(1 + \left(\frac{w}{w_{\text{mat}}}\right)^U\right)^2} \right)
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dgdw</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">g_0</span> <span class="op">*</span> <span class="va">w</span><span class="op">^</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> </span>
<span>  <span class="op">(</span><span class="va">m</span> <span class="op">+</span> <span class="op">(</span><span class="va">m</span>  <span class="op">-</span> <span class="va">U</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">w</span> <span class="op">/</span> <span class="va">w_mat</span><span class="op">)</span><span class="op">^</span><span class="va">U</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">w</span> <span class="op">/</span> <span class="va">w_repro_max</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="va">m</span> <span class="op">-</span> <span class="va">n</span><span class="op">)</span> <span class="op">/</span> </span>
<span>  <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="va">w</span> <span class="op">/</span> <span class="va">w_mat</span><span class="op">)</span><span class="op">^</span><span class="va">U</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We choose diffusion rate to be a power law with exponent <span class="math inline">\(n+1\)</span> which at small size satisfies <span class="math inline">\(d(w) = 0.1 g(w) w\)</span>, see the example at the end of <a href="#sec-diffusion-example" class="quarto-xref">Section 2</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d_0</span> <span class="op">&lt;-</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">g_0</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d_0</span> <span class="op">*</span> <span class="va">w</span><span class="op">^</span><span class="op">(</span><span class="va">n</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">dprime</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">d_0</span> <span class="op">*</span> <span class="va">w</span><span class="op">^</span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Now we calculate the parameters for the numerical scheme.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dtilde</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op">/</span> <span class="va">w</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">dtildeprime</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">d_0</span> <span class="op">*</span> <span class="va">w</span><span class="op">^</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">dtildepp</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">d_0</span> <span class="op">*</span> <span class="va">w</span><span class="op">^</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">gtilde</span> <span class="op">&lt;-</span> <span class="va">g</span> <span class="op">/</span> <span class="va">w</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">dtilde</span></span>
<span><span class="va">gtildeprime</span> <span class="op">&lt;-</span> <span class="va">dgdw</span> <span class="op">-</span> <span class="va">g</span> <span class="op">/</span> <span class="va">w</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">dtildeprime</span></span>
<span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">dtilde</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va">gtilde</span> <span class="op">-</span> <span class="va">dtildeprime</span></span>
<span><span class="va">c</span> <span class="op">&lt;-</span> <span class="va">mu</span> <span class="op">+</span> <span class="va">gtildeprime</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">dtildepp</span></span></code></pre></div>
</div>
<p>We can now solve the ODE.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://sizespectrum.org/mizer/reference/initialN-set.html" class="external-link">initialN</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span><span class="op">[</span><span class="va">species</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">w</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu">solve_steady_state_ode</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span>, <span class="va">n0</span>, <span class="va">h</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in solve_steady_state_ode(a, b, c, n0, h): Stability conditions not</span></span>
<span><span class="co">#&gt; met. Try reducing step size h.</span></span>
<span><span class="co">#&gt; Warning in solve_steady_state_ode(a, b, c, n0, h): Stability condition U + L &lt;=</span></span>
<span><span class="co">#&gt; -D not met.</span></span></code></pre></div>
</div>
<p>We can now plot the result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">n</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="diffusion_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-capitan2010" class="csl-entry" role="listitem">
Capitan, Jose A, and Gustav W. Delius. 2010. <span>‘Scale-Invariant Model of Marine Population Dynamics’</span>. <em>Physical Review E</em> 81 (6): 061901. <a href="https://doi.org/10.1103/PhysRevE.81.061901" class="external-link">https://doi.org/10.1103/PhysRevE.81.061901</a>.
</div>
<div id="ref-datta2010" class="csl-entry" role="listitem">
Datta, Samik, Gustav W. Delius, and Richard Law. 2010. <span>‘A Jump-Growth Model for Predator-Prey Dynamics: Derivation and Application to Marine Ecosystems’</span>. <em>Bulletin of Mathematical Biology</em> 72 (6): 1361–82. <a href="https://doi.org/10.1007/s11538-009-9496-5" class="external-link">https://doi.org/10.1007/s11538-009-9496-5</a>.
</div>
<div id="ref-datta2010a" class="csl-entry" role="listitem">
Datta, Samik, Gustav W. Delius, Richard Law, and Michael J. Plank. 2010. <span>‘A Stability Analysis of the Power-Law Steady State of Marine Size Spectra’</span>. <em>Journal of Mathematical Biology</em> 63 (December): 779–99. <a href="https://doi.org/10.1007/s00285-010-0387-z" class="external-link">https://doi.org/10.1007/s00285-010-0387-z</a>.
</div>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Gustav Delius.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
