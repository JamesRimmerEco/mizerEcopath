---
title: "Creating Size Age-Dataset for Celtic Sea"
format: pdf
editor: visual
---

# Extract and Process Size-Age Data from DATRAS Example for the Celtic Sea

## Initial Data Exploration

Utilize the DATRAS website to via the link below to search for surveys which contain data from selected areas:

<https://gis.ices.dk/geonetwork/srv/eng/catalog.search#/search?isTemplate=n&resourceTemporalDateRange=%7B%22range%22:%7B%22resourceTemporalDateRange%22:%7B%22gte%22:null,%22lte%22:null,%22relation%22:%22intersects%22%7D%7D%7D&sortBy=relevance&sortOrder=&facet.q=type%2Fdataset&resultType=details&from=1&to=30&fast=index&_content_type=json&any=DATRAS&languageStrategy=searchInAllLanguages&query_string=%7B%22resourceType%22:%7B%22dataset%22:true%7D%7D>

List of Surveys that are reported to have data from our defined celtic sea ICES areas ('27.7.B', '27.7.C', '27.7.E', '27.7.F', '27.7.G', '27.7.H', '27.7.J', '27.7.K')

Viewed Surveys with Celtic Sea Data: Based on the Spatial Extent Map tool

-   DATRAS Scottish Rockall Groundfish Survey (SCOROC)

    -   Year: 2011 - Now

    -   Description: The dataset includes age- and length-based catch per unit effort data for commercial fish species collected during the Scottish Rockall Survey. This is a new survey from 2011, replacing historical ROCKALL survey in DATRAS

-   DATRAS Offshore Beam Trawl Surveys (BTS)

    -   Year: 1987 - Now

    -   Description: The Offshore Beam Trawl Surveys include data collected by 4 countries (BE, DE, NL, UK) in the North Sea, Celtic Sea, and Irish Sea. Although, the surveys target plaice and sole, composition of the whole catch is analyzed.

-   DATRAS Inshore Beam Trawl Surveys (DYFS)

    -   Year: 1990 - Now

    -   Description: The Inshore Beam Trawl Surveys include data collected by 4 countries (BE, DE, NL, UK) cover cover most of the coastal and estuarine waters along the continental coast, and are also known as the Youngfish Surveys. Although, the surveys target plaice and sole, composition of the whole catch is analyzed. Responsible survey group is WGBEAM

-   DATRAS Scottish Bottom Trawl Rockall Survey (ROCKALL)

    -   Year: 1999 - 2010

    -   Description: The dataset includes age- and length-based catch per unit effort data for commercial fish species collected during the Scottish Rockall Survey. New survey design was applied from 2011, starting the DATRAS SCOROC dataset

-   DATRAS Irish Ground Fish Survey (IE-IGFS)

    -   Year: 2003 - Now

    -   Description: The dataset includes age- and length-based catch per unit effort data for commercial fish species collected during the Irish Ground Fish trawl survey.

-   DATRAS French Channel Groundfish Survey (FR-CGFS)

    -   Year: 1988 - Now

    -   Description: The dataset includes age- and length-based catch per unit effort data for commercial fish species collected by the French Channel Groundfish Trawl Survey.

-   DATRAS Irish Anglerfish and Megrim Survey (IE-IAMS)

    -   Year: 2016 - Now

    -   Description: The dataset includes age- and length-based catch per unit effort data for commercial fish species collected during the Irish Anglerfish and Megrim survey.

-   DATRAS Spanish Porcupine Bottom Trawl Survey (SP-PORC)

    -   Year: 2001 - Now

    -   Description: The dataset includes age- and length-based catch per unit effort data for commercial fish species collected during the Spanish Porcupine Bottom Trawl Survey.

-   DATRAS French Southern Atlantic Bottom Trawl Survey (EVHOE)

    -   Year: 1997 - Now

    -   Description: The dataset includes age- and length-based catch per unit effort data for commercial fish species collected by the French trawl survey EVHOE.

-   DATRAS North Sea International Bottom Trawl Survey (NS-IBTS)

    -   Year: 1965 - Now

    -   Description: The dataset includes age- and length-based catch per unit effort data for commercial fish species from IBTS in ICES roundfish areas in the North Sea.

Surveys which have Celtic Sea data but were not included:

-   ICES Trawl Survey Datasets (DATRAS)

    -   Year: 1965 - Now

    -   Description: ICES database of trawl surveys

    -   Cannot be extracted from DATRAS download page

-   Marine litter data from DATRAS trawl surveys

    -   About marine litter not size or age data

-   DATRAS Beam Trawl Survey - Irish Sea (VIIa)

    -   Is now obsolete was included in the offshore beam trawl survey dataset

-   DATRAS Central Northeast Atlantic Deepwater Trawl Surveys (DWS)

    -   Has no data present within the loaded data frame

## Loading Potential Data

### Install Packages and Libraries

```{r}
#install.packages("icesDatras")
#install.packages("sf")

#load library
library(purrr)
library(icesDatras)
library(sf)
library(dplyr)
library(stringr)
library(readr)
library(ggplot2)
```

### Load Potential Data

Use function getDATRAS() to load in the 11 surveys containing data from the Celtic Sea listed above. Loading the following chunk takes more than **25 minutes**! This is a drawback of the code because it does not allow you subset the species or area you would like so you need to load thousands of data that is entirely unnecessary.

The column information for each column is detailed here: <https://datras.ices.dk/Data_products/ReportingFormat.aspx>

Load in both the CA and HH data sets for each survey and join by Survey, Year, Quarter, Ship and HaulNo to add on information columns from the HH data to the CA data, this is important for adding the day and month values to each row.

```{r}
#SCOROC
SCOROC_CA <- getDATRAS(record = "CA", survey = "SCOROC", year = 2011:2024, quarter = 1:4) 
SCOROC_HH <- getDATRAS(record = "HH", survey = "SCOROC", year = 1985:2024, quarter = 1:4)|>
    filter(HaulVal == "V") |>
    distinct(Survey, Year, Quarter, Ship, HaulNo, .keep_all = TRUE)
SCOROC_HH_CA <- left_join(SCOROC_CA, SCOROC_HH,
                 by = c("Survey", "Year", "Quarter", "Ship", "HaulNo"))

#BTS
BTS_CA <- getDATRAS(record = "CA", survey = "BTS", year = 1985:2024, quarter = 1:4)
BTS_HH <- getDATRAS(record = "HH", survey = "BTS", year = 1985:2024, quarter = 1:4)|>
    filter(HaulVal == "V") |>
    distinct(Survey, Year, Quarter, Ship, HaulNo, .keep_all = TRUE)
BTS_HH_CA <- left_join(BTS_CA, BTS_HH,
                 by = c("Survey", "Year", "Quarter", "Ship", "HaulNo"))
    
#DYFS
DYFS_CA <- getDATRAS(record = "CA", survey = "DYFS", year = 1985:2024, quarter = 1:4) 
DYFS_HH <- getDATRAS(record = "HH", survey = "DYFS", year = 1985:2024, quarter = 1:4)|>
    filter(HaulVal == "V") |>
    distinct(Survey, Year, Quarter, Ship, HaulNo, .keep_all = TRUE)
DYFS_HH_CA <- left_join(DYFS_CA, DYFS_HH,
                 by = c("Survey", "Year", "Quarter", "Ship", "HaulNo"))
  
#ROCKALL
ROCKALL_CA <- getDATRAS(record = "CA", survey = "ROCKALL", year = c(1999,2001:2003,2005:2009), quarter = 1:4) 
ROCKALL_HH <- getDATRAS(record = "HH", survey = "ROCKALL", year = 1985:2024, quarter = 1:4)|>
    filter(HaulVal == "V") |>
    distinct(Survey, Year, Quarter, Ship, HaulNo, .keep_all = TRUE)
ROCKALL_HH_CA <- left_join(ROCKALL_CA, ROCKALL_HH,
                 by = c("Survey", "Year", "Quarter", "Ship", "HaulNo"))
  
#IE-IGFS
IE_IGFS_CA <- getDATRAS(record = "CA", survey = "IE-IGFS", year = 2003:2024, quarter = 1:4) 
IE_IGFS_HH <- getDATRAS(record = "HH", survey = "IE-IGFS", year = 1985:2024, quarter = 1:4)|>
    filter(HaulVal == "V") |>
    distinct(Survey, Year, Quarter, Ship, HaulNo, .keep_all = TRUE)
IE_IGFS_HH_CA <- left_join(IE_IGFS_CA, IE_IGFS_HH,
                 by = c("Survey", "Year", "Quarter", "Ship", "HaulNo"))

#FR-CGFS
FR_CGFS_CA <- getDATRAS(record = "CA", survey = "FR-CGFS", year = 1988:2024, quarter = 1:4) 
FR_CGFS_HH <- getDATRAS(record = "HH", survey = "FR-CGFS", year = 1985:2024, quarter = 1:4)|>
    filter(HaulVal == "V") |>
    distinct(Survey, Year, Quarter, Ship, HaulNo, .keep_all = TRUE)
FR_CGFS_HH_CA <- left_join(FR_CGFS_CA, FR_CGFS_HH,
                 by = c("Survey", "Year", "Quarter", "Ship", "HaulNo"))

#IE-IAMS
IE_IAMS_CA <- getDATRAS(record = "CA", survey = "IE-IAMS", year = 2016:2024, quarter = 1:4) 
IE_IAMS_HH <- getDATRAS(record = "HH", survey = "IE-IAMS", year = 1985:2024, quarter = 1:4)|>
    filter(HaulVal == "V") |>
    distinct(Survey, Year, Quarter, Ship, HaulNo, .keep_all = TRUE)
IE_IAMS_HH_CA <- left_join(IE_IAMS_CA, IE_IAMS_HH,
                 by = c("Survey", "Year", "Quarter", "Ship", "HaulNo"))

#SP-PORC
SP_PORC_CA <- getDATRAS(record = "CA", survey = "SP-PORC", year = 2001:2024, quarter = 1:4)  
SP_PORC_HH <- getDATRAS(record = "HH", survey = "SP-PORC", year = 1985:2024, quarter = 1:4)|>
    filter(HaulVal == "V") |>
    distinct(Survey, Year, Quarter, Ship, HaulNo, .keep_all = TRUE)
SP_PORC_HH_CA <- left_join(SP_PORC_CA, SP_PORC_HH,
                 by = c("Survey", "Year", "Quarter", "Ship", "HaulNo"))

#EVHOE
EVHOE_CA <- getDATRAS(record = "CA", survey = "EVHOE", year = 1997:2024, quarter = 1:4) 
EVHOE_HH <- getDATRAS(record = "HH", survey = "EVHOE", year = 1985:2024, quarter = 1:4)|>
    filter(HaulVal == "V") |>
    distinct(Survey, Year, Quarter, Ship, HaulNo, .keep_all = TRUE)
EVHOE_HH_CA <- left_join(EVHOE_CA, EVHOE_HH,
                 by = c("Survey", "Year", "Quarter", "Ship", "HaulNo"))

#NS-IBTS
NS_IBTS_CA <- getDATRAS(record = "CA", survey = "NS-IBTS", year = 1965:2025, quarter = 1:4) 
NS_IBTS_HH <- getDATRAS(record = "HH", survey = "NS-IBTS", year = 1985:2024, quarter = 1:4)|>
    filter(HaulVal == "V") |>
    distinct(Survey, Year, Quarter, Ship, HaulNo, .keep_all = TRUE)
NS_IBTS_HH_CA <- left_join(NS_IBTS_CA, NS_IBTS_HH,
                 by = c("Survey", "Year", "Quarter", "Ship", "HaulNo"))
```

# Clean and Organize Data

```{r}
#rbind data together into singular dataset
data<-rbind(SCOROC_HH_CA,BTS_HH_CA,DYFS_HH_CA,ROCKALL_HH_CA,IE_IGFS_HH_CA,FR_CGFS_HH_CA,IE_IAMS_HH_CA,SP_PORC_HH_CA,EVHOE_HH_CA,NS_IBTS_HH_CA)
```

## Subset Desired Celtic Sea Species

```{r}
#remove rows that do not contain the North Sea Desired Species
clean_data<-subset(data, SpecCode %in% c(126417,126436,126437,126438,126439,126484,126555,126822,127023,127143,127146,127160))
#SpecCode to scientific name dictionary is detailed below
```

## Subset Desired Celtic Sea Area

In this section some the the Area Codes generated in the data set loaded from DATRAS are given in different formats, additionally the data frames which load in should have a AreaType Column which should correlate with these codes. After extensive exploration of the data it has become evident this is not the case. Therefore, based on the structure of the AreaCode value an ICES area value is assigned. Only ICES statistical rectangle and ICES area codes are analysed all other area codes are given the value NA and later removed from the data set. This was performed due to the fact that other area codes provided did not give a clear indication that the data included was only from the Celtic Sea and not nearby areas.

### Load in and Apply Dictionary Between ICES rectangles and ICES areas

Processing code of overlapping spatial areas is available in inst/extdata.

```{r}
rect_to_area<-read_csv("/Users/jessicawestworth/Desktop/Mizer Work/Projects/mizerEcopathedits/inst/extdata/ICES Rectangle to Area.csv")
colnames(rect_to_area)<-c("AreaCode","ICES_Area")

data_working <- clean_data %>%
    left_join(rect_to_area, by = c("AreaCode"))

data_add_areas <- data_working %>%
    mutate(
        ICES_Area = case_when(
            is.na(ICES_Area) & AreaCode == "VIIa" ~ "27.7.a",
            is.na(ICES_Area) & AreaCode == "VIIb" ~ "27.7.b",
            is.na(ICES_Area) & AreaCode == "VIIc" ~ "27.7.c",
            is.na(ICES_Area) & AreaCode == "VIId" ~ "27.7.d",
            is.na(ICES_Area) & AreaCode == "VIIe" ~ "27.7.e",
            is.na(ICES_Area) & AreaCode == "VIIf" ~ "27.7.f",
            is.na(ICES_Area) & AreaCode == "VIIg" ~ "27.7.g",
            is.na(ICES_Area) & AreaCode == "VIIh" ~ "27.7.h",
            is.na(ICES_Area) & AreaCode == "VIIj" ~ "27.7.j",
            is.na(ICES_Area) & AreaCode == "VIIk" ~ "27.7.k",
            TRUE ~ ICES_Area  # keep original value if not NA or no match
        )
    )
```

## Subset areas

```{r}
cs_subarea<-c('27.7.b', '27.7.c', '27.7.c.1', '27.7.c.2', '27.7.e', '27.7.f', '27.7.g', '27.7.h', '27.7.j','27.7.j.1','27.7.j.2', '27.7.k','27.7.k.1','27.7.k.2')

cs_data<- data_add_areas %>%
  filter(map_lgl(str_split(ICES_Area, "-"), ~ any(.x %in% cs_subarea)))
```

## Dictionaries

### Species Code

Go to: <https://datras.ices.dk/Data_products/qryspec.aspx>

```{r}
cs_data$SpecCode<-as.factor(cs_data$SpecCode)

SpecCode_to_Latinname<-c("126417"="Clupea harengus",
                         "126436"="Gadus morhua",
                         "126437"="Melanogrammus aeglefinus",
                         "126438"="Merlangius merlangus",
                         "126439"="Micromesistius poutassou",
                         "126484"="Merluccius merluccius",
                         "126555"="Lophius piscatorius",
                         "126822"="Trachurus trachurus",
                         "127023"="Scomber scombrus",
                         "127143"="Pleuronectes platessa",
                         "127146"="Lepidorhombus whiffiagonis",
                         "127160"="Solea solea")

cs_data$Scientific_name <- SpecCode_to_Latinname[cs_data$SpecCode]
```

### Simplify Maturity Code

Go to: <https://vocab.ices.dk/?CodeTypeRelID=361&CodeID=34402>

```{r}
cs_data_maturity <- cs_data %>%
  mutate(
    Maturity = case_when(
      Maturity %in% c("2","3","4","5","52","53","54","55","62","63","64","65","B","Ba","Bb","C","Ca","Cb","D","Da","Db","E","II","III","IV","IX","M","R1_2","R1_3","R1_4","R2_4","R2_6","R2_8","RF2","RF3","RF4","RF5","RF6","S2","S3","S4","S5","S6","V","VI","VII","VIII","X") ~ "mature",
      Maturity %in% c("6","66","F") ~ NA_character_,
      Maturity %in% c("1","51","61","A","I","R1_1","R2_2","RF1","S1") ~ "immature",
      Maturity %in% "-9" ~ NA_character_,
      TRUE ~ NA_character_
    )
)
```

## Standardize Length Classes

We want to convert the length to cm. So we will divide LngtClass Columns with LngtCode (".") by 10. BTS surveyalso has a value for 1 which should be centimeters.

```{r}
#check that these are the only codes we have
#make the coversion
cs_data_length_corrected<-cs_data_maturity%>%
    mutate(LngtClass = case_when(
        LngtCode == "."~ LngtClass/10,
        LngtCode == "1"~ LngtClass,
    ))
```

## Aggregating

```{r}
cs_age_size <- cs_data_length_corrected %>%
  group_by(Survey, Quarter, Scientific_name, Year, Month, Day, Sex, LngtClass, IndWgt, Maturity, Age) %>%
  summarise(
    CANoAtLngt = sum(CANoAtLngt, na.rm = TRUE),  # sum ignoring NAs
    .groups = "drop"  # ungroup the result
  )

#saveRDS(cs_age_size, "/Users/jessicawestworth/Desktop/Mizer Work/Projects/mizerEcopathedits/inst/extdata/Celtic_Sea_Size_at_Age_w_Sex_Data.rds")

#cs_age_size<-readRDS("/Users/jessicawestworth/Desktop/Mizer Work/Projects/mizerEcopathedits/inst/extdata/Celtic_Sea_Size_at_Age_w_Sex_Data.rds")
```

## NA Values for IndWgt

```{r}
cs_age_size_corrected_weight <- cs_age_size %>%
  mutate( IndWgt = ifelse(IndWgt == -9, NA, IndWgt))
```

## Make weight class column

### Insert average a and b values for each species

```{r}
### Life history data
life_histories <- read_csv(
    "/Users/jessicawestworth/Desktop/Mizer Work/Projects/Mizer_FMP_EwE/Data/life_histories.csv",
    locale = locale(encoding = "Latin1")
)

#Extract a and b values for each species
life_histories_summary <- life_histories %>%
    group_by(Species, a, b)%>%
    summarise(.groups = "drop"  # ungroup the result
  )

#add a and b column to cs_age_size data
cs_age_size_LWR <- cs_age_size_corrected_weight %>%
  left_join(life_histories_summary, by = c("Scientific_name" = "Species"))
```

### Create new WgtClass column

```{r}
cs_age_size_WgtClass <- cs_age_size_LWR %>%
  mutate(
    WgtClass = ifelse(
      !is.na(IndWgt),
      IndWgt,
      a * (LngtClass ^ b)
    )
  )
```

## Final Data Aggregation

```{r}
cs_age_size <- cs_age_size_WgtClass %>%
  group_by(Survey, Quarter, Scientific_name, Year, Month, Day, a, b, WgtClass, LngtClass, IndWgt, Maturity, Age) %>%
  summarise(
    CANoAtLngt = sum(CANoAtLngt, na.rm = TRUE),  # sum ignoring NAs
    .groups = "drop"  # ungroup the result
  )

#saveRDS(cs_age_size, "/Users/jessicawestworth/Desktop/Mizer Work/Projects/mizerEcopathedits/inst/extdata/Celtic_Sea_Size_at_Age_Data.rds")
```

## Determining area of Celtic sea

```{r}
area<-subset(areas, Area_Full %in% c('27.7.b', '27.7.c', '27.7.c.1', '27.7.c.2', '27.7.e', '27.7.f', '27.7.g', '27.7.h', '27.7.j','27.7.j.1','27.7.j.2', '27.7.k','27.7.k.1','27.7.k.2'))
sum(area$Area_km2)
#617499.7
```
